<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ org_name }} – Shadowserver Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --primary-color: #5c7cfa;
  --primary-hover: #4263eb;
  --bg-dark: #0f1117;
  --bg-panel: #1a1e2e;
  --bg-card: #252a3a;
  --bg-card-alt: #2a2f3f;
  --text-light: #eaeaea;
  --text-muted: #a0a0a0;
  --border-color: rgba(255, 255, 255, 0.1);
  --shadow-color: rgba(0, 0, 0, 0.6);
  --critical: #ff4c4c;
  --high: #ff944c;
  --medium: #ffc107;
  --low: #17c0eb;
  --info: #9e9e9e;
  --transition-speed: 0.3s;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
  background: var(--bg-dark);
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  color: var(--text-light);
  line-height: 1.7;
  overflow-x: hidden;
}

.container {
  margin: 40px auto;
  padding: 30px;
  background: var(--bg-panel);
  border-radius: 24px;
  box-shadow: 0 15px 30px var(--shadow-color);
  border: 1px solid var(--border-color);
  opacity: 0;
  transform: translateY(20px);
  animation: fadeIn 0.6s ease-out forwards;
}

@keyframes fadeIn {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes pulse {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.05);
  }
  100% {
    transform: scale(1);
  }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.section {
  margin-top: 40px;
  opacity: 0;
  animation: fadeInUp 0.6s ease-out forwards;
  animation-delay: calc(var(--delay, 0) * 0.1s);
}

h1 {
  font-size: 2.5rem;
  font-weight: 700;
  color: #ffffff;
  border-left: 5px solid var(--primary-color);
  padding-left: 15px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  position: relative;
  overflow: hidden;
  animation: slideIn 0.5s ease-out;
}

h1::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(90deg, var(--primary-color), transparent);
}

h2 {
  color: #ffffff;
  font-size: 1.8rem;
  margin-top: 40px;
  margin-bottom: 20px;
  padding-left: 15px;
  border-left: 5px solid var(--primary-color);
  display: inline-block;
  position: relative;
}

h2::after {
  content: '';
  position: absolute;
  bottom: -5px;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(90deg, var(--primary-color), transparent);
  transform: scaleX(0);
  transform-origin: left;
  transition: transform 0.3s ease;
}

h2:hover::after {
  transform: scaleX(1);
}

.info {
  margin: 20px 0 30px;
  padding: 20px;
  background: rgba(92, 124, 250, 0.05);
  border-radius: 12px;
  border-left: 4px solid var(--primary-color);
  font-size: 0.95em;
  color: var(--text-light);
  backdrop-filter: blur(5px);
  animation: fadeInUp 0.6s ease-out forwards;
  animation-delay: 0.2s;
}

.info strong {
  color: #ffffff;
  display: inline-block;
  min-width: 120px;
  position: relative;
}

.info p {
  margin: 10px 0;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin: 20px 0;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  opacity: 0;
  animation: fadeInUp 0.6s ease-out forwards;
  animation-delay: calc(var(--delay, 0) * 0.1s + 0.3s);
}

th, td {
  padding: 15px 20px;
  text-align: left;
}

th {
  background: linear-gradient(135deg, var(--primary-color), #4263eb);
  color: #ffffff;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.85em;
  letter-spacing: 0.05em;
  position: sticky;
  top: 0;
  z-index: 10;
}

tbody tr {
  transition: all var(--transition-speed);
  background-color: var(--bg-card);
}

tbody tr:nth-child(even) {
  background-color: var(--bg-card-alt);
}

tbody tr:hover {
  background-color: rgba(92, 124, 250, 0.1);
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

a {
  color: var(--primary-color);
  text-decoration: none;
  transition: all var(--transition-speed);
  position: relative;
}

a:hover {
  color: var(--primary-hover);
}

a::after {
  content: '';
  position: absolute;
  width: 100%;
  height: 2px;
  bottom: -2px;
  left: 0;
  background-color: var(--primary-color);
  transform: scaleX(0);
  transition: transform 0.3s ease;
}

a:hover::after {
  transform: scaleX(1);
}

.badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 5px 12px;
  border-radius: 50px;
  font-size: 0.8em;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  transition: all 0.3s ease;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
}

.badge:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 12px rgba(0, 0, 0, 0.25);
}

.severity-CRITICAL .badge { 
  background: linear-gradient(135deg, var(--critical), #ff2d2d);
  color: white;
}

.severity-HIGH .badge { 
  background: linear-gradient(135deg, var(--high), #ff7b29);
  color: white;
}

.severity-MEDIUM .badge { 
  background: linear-gradient(135deg, var(--medium), #e5ac00);
  color: black;
}

.severity-LOW .badge { 
  background: linear-gradient(135deg, var(--low), #00a8d4);
  color: white;
}

.severity-INFO .badge { 
  background: linear-gradient(135deg, var(--info), #727272);
  color: white;
}

.search-container {
  position: relative;
  max-width: 500px;
  margin: 20px 0;
}

.search-input {
  padding: 12px 20px 12px 45px;
  border: 2px solid transparent;
  border-radius: 50px;
  width: 100%;
  background-color: rgba(255, 255, 255, 0.08);
  color: var(--text-light);
  font-size: 1em;
  transition: all var(--transition-speed);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.search-container::before {
  content: '\f002';
  font-family: 'Font Awesome 6 Free';
  font-weight: 900;
  position: absolute;
  left: 20px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  z-index: 1;
  transition: all var(--transition-speed);
}

.search-input:focus {
  outline: none;
  border-color: var(--primary-color);
  background-color: rgba(255, 255, 255, 0.12);
  box-shadow: 0 5px 20px rgba(92, 124, 250, 0.25);
}

.search-input:focus + .search-container::before {
  color: var(--primary-color);
}

.chart-wrapper {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 30px;
  margin: 40px 0;
  opacity: 0;
  transform: translateY(20px);
  animation: fadeInUp 0.8s ease-out forwards;
  animation-delay: 0.5s;
}

.chart-card {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
  border: 1px solid var(--border-color);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.chart-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
  border-color: var(--primary-color);
}

.chart-card::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(92, 124, 250, 0.1), transparent 70%);
  opacity: 0;
  transition: opacity 0.5s ease;
}

.chart-card:hover::before {
  opacity: 1;
}

canvas {
  width: 100% !important;
  height: auto !important;
  max-height: 400px;
  border-radius: 8px;
}

.tlp-footer {
  margin-top: 60px;
  padding: 20px;
  background: rgba(255, 165, 0, 0.05);
  border-radius: 12px;
  border-left: 4px solid #ff9900;
  font-size: 0.9em;
  color: var(--text-muted);
  text-align: center;
  position: relative;
  overflow: hidden;
  opacity: 0;
  animation: fadeInUp 0.6s ease-out forwards;
  animation-delay: 0.7s;
}

.tlp-footer::before {
  content: '\f023';
  font-family: 'Font Awesome 6 Free';
  font-weight: 900;
  font-size: 1.2em;
  margin-right: 10px;
  color: #ff9900;
}

/* Pagination Styles */
.pagination-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 20px 0;
  flex-wrap: wrap;
  gap: 15px;
}

.pagination-controls {
  display: flex;
  align-items: center;
  gap: 5px;
}

.pagination-button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 36px;
  height: 36px;
  padding: 0 10px;
  border-radius: 8px;
  background-color: var(--bg-card);
  color: var(--text-light);
  border: 1px solid var(--border-color);
  font-size: 0.9em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.pagination-button:hover:not(.disabled) {
  background-color: rgba(92, 124, 250, 0.1);
  border-color: var(--primary-color);
  transform: translateY(-2px);
}

.pagination-button.active {
  background-color: var(--primary-color);
  border-color: var(--primary-color);
  color: white;
  box-shadow: 0 4px 10px rgba(92, 124, 250, 0.3);
}

.pagination-button.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.pagination-info {
  font-size: 0.9em;
  color: var(--text-muted);
}

.pagination-size-selector {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9em;
  color: var(--text-muted);
}

.page-size-select {
  padding: 6px 10px;
  background-color: var(--bg-card);
  color: var(--text-light);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  font-size: 0.9em;
  outline: none;
  transition: all 0.3s ease;
  cursor: pointer;
}

.page-size-select:focus {
  border-color: var(--primary-color);
}

/* Animation for table rows on load */
tbody tr {
  opacity: 0;
  transform: translateY(10px);
  animation: fadeInUp 0.4s ease-out forwards;
}

/* Staggered animations for table rows */
tbody tr:nth-child(1) { animation-delay: 0.3s; }
tbody tr:nth-child(2) { animation-delay: 0.35s; }
tbody tr:nth-child(3) { animation-delay: 0.4s; }
tbody tr:nth-child(4) { animation-delay: 0.45s; }
tbody tr:nth-child(5) { animation-delay: 0.5s; }
tbody tr:nth-child(6) { animation-delay: 0.55s; }
tbody tr:nth-child(7) { animation-delay: 0.6s; }
tbody tr:nth-child(8) { animation-delay: 0.65s; }
tbody tr:nth-child(9) { animation-delay: 0.7s; }
tbody tr:nth-child(10) { animation-delay: 0.75s; }

/* Show more rows immediately after the first 10 */
tbody tr:nth-child(n+11) { animation-delay: 0.8s; }

/* Pulse animation for critical severity badges */
.severity-CRITICAL .badge {
  animation: pulse 2s infinite;
}

/* Scrollbar styling */
::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}

::-webkit-scrollbar-track {
  background: var(--bg-dark);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb {
  background: var(--primary-color);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--primary-hover);
}

/* Responsive adjustments */
@media screen and (max-width: 992px) {
  .container {
    margin: 20px;
    padding: 20px;
  }
  
  h1 {
    font-size: 2rem;
  }
  
  h2 {
    font-size: 1.5rem;
  }
  
  .chart-wrapper {
    grid-template-columns: 1fr;
  }
}

@media screen and (max-width: 768px) {
  .container {
    padding: 15px;
  }
  
  th, td {
    padding: 12px 10px;
  }
  
  th {
    font-size: 0.8em;
  }
  
  .table-responsive {
    overflow-x: auto;
  }

  .pagination-container {
    flex-direction: column;
    align-items: flex-start;
  }
}

@media screen and (max-width: 576px) {
  h1 {
    font-size: 1.8rem;
  }
  
  h2 {
    font-size: 1.3rem;
  }
  
  .info {
    padding: 15px;
  }
  
  .badge {
    padding: 4px 8px;
    font-size: 0.7em;
  }
}
</style>
</head>
<script>
// Search table functionality
function searchTable(id, query) {
  query = query.toLowerCase();
  const table = document.getElementById(id);
  const tbody = table.querySelector('tbody');
  const rows = tbody.querySelectorAll('tr');
  
  // First, remove any existing animations
  rows.forEach(row => {
    row.style.animation = 'none';
  });
  
  // Apply filter and toggle filtered-out class
  rows.forEach(row => {
    const text = row.innerText.toLowerCase();
    const matches = text.includes(query);
    
    // Add or remove filtered-out class based on whether it matches
    row.classList.toggle('filtered-out', !matches);
    
    // Hide non-matching rows completely to prevent them from being counted in pagination
    row.style.display = matches ? '' : 'none';
    
    // Clear any existing animations
    row.style.animation = 'none';
    row.style.opacity = '0'; // Reset opacity for all rows
  });
  
  // Force reflow
  tbody.offsetHeight;
  
  // Apply appropriate sorting for this table
  applyTableSort(id);
  
  // Reset pagination to first page with new filtered data
  updatePagination(id, 1, true);
}

// Store sorting functions for different tables
const tableSortFunctions = {
  "categoryTable": sortCategoryBySeverity,
  "ipTable": sortIpTableByIp,
  "prefixTable": sortPrefixTableByPrefix
};

// Function to apply the appropriate sort to a table
function applyTableSort(tableId) {
  if (tableSortFunctions[tableId]) {
    tableSortFunctions[tableId]();
  }
}

// Sort category table by severity
function sortCategoryBySeverity() {
  const table = document.getElementById("categoryTable");
  if (!table) return;
  
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr:not(.filtered-out)'));
  const severityOrder = { 'CRITICAL': 1, 'HIGH': 2, 'MEDIUM': 3, 'LOW': 4, 'INFO': 5 };
  
  rows.sort((a, b) => {
    const severityA = severityOrder[a.cells[0].innerText.trim().toUpperCase()] || 99;
    const severityB = severityOrder[b.cells[0].innerText.trim().toUpperCase()] || 99;
    return severityA - severityB;
  });
  
  // Clear and re-append sorted rows
  rows.forEach(row => tbody.appendChild(row));
}

// Sort IP table by IP addresses
function sortIpTableByIp() {
  const table = document.getElementById("ipTable");
  if (!table) return;
  
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr:not(.filtered-out)'));
  
  rows.sort((a, b) => {
    // Extract IP addresses from first cell
    const ipA = a.cells[0].innerText.trim();
    const ipB = b.cells[0].innerText.trim();
    
    // Compare IP addresses numerically
    return compareIpAddresses(ipA, ipB);
  });
  
  // Clear and re-append sorted rows
  rows.forEach(row => tbody.appendChild(row));
}

// Sort prefix table by prefixes
function sortPrefixTableByPrefix() {
  const table = document.getElementById("prefixTable");
  if (!table) return;
  
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr:not(.filtered-out)'));
  
  rows.sort((a, b) => {
    // Extract prefixes from first cell
    const prefixA = a.cells[0].innerText.trim();
    const prefixB = b.cells[0].innerText.trim();
    
    // Compare prefixes (CIDR notation)
    return compareCidrPrefixes(prefixA, prefixB);
  });
  
  // Clear and re-append sorted rows
  rows.forEach(row => tbody.appendChild(row));
}

// Helper function to compare IP addresses numerically
function compareIpAddresses(ipA, ipB) {
  const partsA = ipA.split('.').map(Number);
  const partsB = ipB.split('.').map(Number);
  
  for (let i = 0; i < 4; i++) {
    if (partsA[i] !== partsB[i]) {
      return partsA[i] - partsB[i];
    }
  }
  return 0;
}

// Helper function to compare CIDR prefixes (e.g., "192.168.0.0/24")
function compareCidrPrefixes(prefixA, prefixB) {
  // Split IP and subnet mask
  const [ipA, maskA] = prefixA.split('/');
  const [ipB, maskB] = prefixB.split('/');
  
  // First compare subnet masks (smaller masks first)
  const maskCompare = parseInt(maskA) - parseInt(maskB);
  if (maskCompare !== 0) return maskCompare;
  
  // If masks are equal, compare IP addresses
  return compareIpAddresses(ipA, ipB);
}

// Initialize pagination for a table
function initPagination(tableId) {
  const table = document.getElementById(tableId);
  if (!table) return;
  
  // Add data attribute to track current page and rows per page
  table.dataset.currentPage = '1';
  table.dataset.rowsPerPage = '10';
  table.dataset.previouslyVisibleRows = ''; // Track which rows were visible
  
  // Make all rows visible by default
  const tbody = table.querySelector('tbody');
  const rows = tbody.querySelectorAll('tr');
  rows.forEach(row => {
    row.classList.remove('filtered-out');
    row.style.display = '';
  });
  
  // Create pagination container if it doesn't exist
  let paginationContainer = document.getElementById(`${tableId}-pagination`);
  if (!paginationContainer) {
    paginationContainer = document.createElement('div');
    paginationContainer.id = `${tableId}-pagination`;
    paginationContainer.className = 'pagination-container';
    
    const sizeSelector = document.createElement('div');
    sizeSelector.className = 'pagination-size-selector';
    sizeSelector.innerHTML = `
      <span>Show</span>
      <select id="${tableId}-page-size" class="page-size-select" onchange="changePageSize('${tableId}', this.value)">
        <option value="5">5</option>
        <option value="10" selected>10</option>
        <option value="20">20</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
      <span>entries</span>
    `;
    
    const info = document.createElement('div');
    info.id = `${tableId}-pagination-info`;
    info.className = 'pagination-info';
    
    const controls = document.createElement('div');
    controls.id = `${tableId}-pagination-controls`;
    controls.className = 'pagination-controls';
    
    paginationContainer.appendChild(sizeSelector);
    paginationContainer.appendChild(info);
    paginationContainer.appendChild(controls);
    
    // Add pagination container after the table
    table.parentNode.insertBefore(paginationContainer, table.nextSibling);
  }
  
  // Initialize with page 1
  updatePagination(tableId, 1);
}

// Update pagination display and controls
function updatePagination(tableId, page, isSearch = false) {
  const table = document.getElementById(tableId);
  if (!table) return;
  
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr:not(.filtered-out)'));
  
  // Update current page
  const rowsPerPage = parseInt(table.dataset.rowsPerPage) || 10;
  table.dataset.currentPage = page.toString();
  
  // Calculate pagination info
  const totalRows = rows.length;
  const totalPages = Math.ceil(totalRows / rowsPerPage);
  const startIndex = (page - 1) * rowsPerPage;
  const endIndex = Math.min(startIndex + rowsPerPage, totalRows);
  
  // Get currently visible rows for comparison
  const previouslyVisibleRows = table.dataset.previouslyVisibleRows 
    ? table.dataset.previouslyVisibleRows.split(',').map(Number) 
    : [];
  
  // Build new list of visible row indices
  const newlyVisibleRows = [];
  for (let i = startIndex; i < endIndex; i++) {
    newlyVisibleRows.push(i);
  }
  
  // Hide all rows that aren't filtered out
  rows.forEach((row, idx) => {
    row.style.display = 'none';
  });
  
  // Show only rows for current page with appropriate animations
  for (let i = startIndex; i < endIndex; i++) {
    if (rows[i]) {
      const row = rows[i];
      row.style.display = '';
      
      if (isSearch) {
        // For search results, always animate in
        row.style.animation = `fadeInUp 0.3s ease-out ${(i - startIndex) * 0.05}s forwards`;
      } else {
        // For regular pagination, only animate rows that weren't visible before
        const wasVisible = previouslyVisibleRows.includes(i);
        if (!wasVisible) {
          row.style.opacity = '0'; // Start transparent
          row.style.animation = `fadeInUp 0.3s ease-out ${(i - startIndex) * 0.05}s forwards`;
        } else {
          row.style.opacity = '1'; // Already visible
          row.style.animation = 'none';
        }
      }
    }
  }
  
  // Store currently visible rows for next comparison
  table.dataset.previouslyVisibleRows = newlyVisibleRows.join(',');
  
  // Update pagination info text
  const infoElement = document.getElementById(`${tableId}-pagination-info`);
  if (infoElement) {
    const start = totalRows > 0 ? startIndex + 1 : 0;
    infoElement.textContent = `Showing ${start} to ${endIndex} of ${totalRows} entries`;
  }
  
  // Update pagination controls
  const controlsElement = document.getElementById(`${tableId}-pagination-controls`);
  if (controlsElement) {
    // Clear existing controls
    controlsElement.innerHTML = '';
    
    if (totalPages <= 1) {
      return; // No pagination needed
    }
    
    // Previous button
    const prevButton = document.createElement('button');
    prevButton.className = `pagination-button ${page <= 1 ? 'disabled' : ''}`;
    prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
    prevButton.disabled = page <= 1;
    prevButton.addEventListener('click', () => {
      if (page > 1) updatePagination(tableId, page - 1);
    });
    controlsElement.appendChild(prevButton);
    
    // Page buttons
    const maxButtons = 5; // Maximum number of page buttons to show
    let startBtn = Math.max(1, page - Math.floor(maxButtons / 2));
    let endBtn = Math.min(totalPages, startBtn + maxButtons - 1);
    
    // Adjust if we're near the end
    if (endBtn - startBtn < maxButtons - 1) {
      startBtn = Math.max(1, endBtn - maxButtons + 1);
    }
    
    // First page button
    if (startBtn > 1) {
      const firstBtn = document.createElement('button');
      firstBtn.textContent = '1';
      firstBtn.className = 'pagination-button';
      firstBtn.addEventListener('click', () => updatePagination(tableId, 1));
      controlsElement.appendChild(firstBtn);
      
      // Ellipsis
      if (startBtn > 2) {
        const ellipsis = document.createElement('span');
        ellipsis.textContent = '...';
        ellipsis.className = 'pagination-button disabled';
        controlsElement.appendChild(ellipsis);
      }
    }
    
    // Page number buttons
    for (let i = startBtn; i <= endBtn; i++) {
      const pageBtn = document.createElement('button');
      pageBtn.textContent = i.toString();
      pageBtn.className = `pagination-button ${i === page ? 'active' : ''}`;
      pageBtn.addEventListener('click', () => updatePagination(tableId, i));
      controlsElement.appendChild(pageBtn);
    }
    
    // Last page button
    if (endBtn < totalPages) {
      // Ellipsis
      if (endBtn < totalPages - 1) {
        const ellipsis = document.createElement('span');
        ellipsis.textContent = '...';
        ellipsis.className = 'pagination-button disabled';
        controlsElement.appendChild(ellipsis);
      }
      
      const lastBtn = document.createElement('button');
      lastBtn.textContent = totalPages.toString();
      lastBtn.className = 'pagination-button';
      lastBtn.addEventListener('click', () => updatePagination(tableId, totalPages));
      controlsElement.appendChild(lastBtn);
    }
    
    // Next button
    const nextButton = document.createElement('button');
    nextButton.className = `pagination-button ${page >= totalPages ? 'disabled' : ''}`;
    nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
    nextButton.disabled = page >= totalPages;
    nextButton.addEventListener('click', () => {
      if (page < totalPages) updatePagination(tableId, page + 1);
    });
    controlsElement.appendChild(nextButton);
  }
}

// Change page size
function changePageSize(tableId, size) {
  const table = document.getElementById(tableId);
  if (!table) return;
  
  // Clear previously visible rows tracking when changing page size
  table.dataset.previouslyVisibleRows = '';
  
  // Update stored rows per page
  table.dataset.rowsPerPage = size;
  
  // Reset to first page with new size
  updatePagination(tableId, 1, true);
}

// Initialize pagination when DOM is loaded
document.addEventListener("DOMContentLoaded", () => {
  // Add animation classes to sections
  const sections = document.querySelectorAll('.section');
  sections.forEach((section, index) => {
    section.style.setProperty('--delay', index + 1);
  });

  // Apply initial sorting to all tables
  sortCategoryBySeverity();
  sortIpTableByIp();
  sortPrefixTableByPrefix();

  // Initialize pagination for all tables
  initPagination('ipTable');
  initPagination('prefixTable');
  initPagination('categoryTable');
  
    // Define severity color mapping
  const severityColors = {
    'CRITICAL': '#ff4c4c',
    'HIGH': '#ff944c',
    'MEDIUM': '#ffc107',
    'LOW': '#17c0eb',
    'INFO': '#999999'
  };

  // Extract data from the category table
  const severityCounts = {};
  const categoryCounts = {};
  const categorySeverity = {};

  document.querySelectorAll('#categoryTable tbody tr').forEach(row => {
    const severity = row.cells[0].innerText.trim().toUpperCase();
    const category = row.cells[3].innerText.trim();
    const count = parseInt(row.cells[4].innerText.trim()) || 1;

    severityCounts[severity] = (severityCounts[severity] || 0) + count;
    categoryCounts[category] = (categoryCounts[category] || 0) + count;
    categorySeverity[category] = severity; // Store severity for this category
  });

  // Function to create and animate charts
  const makeChart = (ctxId, dataObj, labelText, colorCallback) => {
    const ctx = document.getElementById(ctxId);
    if (!ctx) return;
    
    // Add animation to chart
    ctx.style.opacity = 0;
    ctx.style.transform = 'scale(0.9)';
    
    setTimeout(() => {
      ctx.style.transition = 'all 0.6s ease-out';
      ctx.style.opacity = 1;
      ctx.style.transform = 'scale(1)';
      
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: Object.keys(dataObj),
          datasets: [{
            label: labelText,
            data: Object.values(dataObj),
            backgroundColor: Object.keys(dataObj).map(colorCallback),
            borderColor: '#1a1e2e',
            borderWidth: 2,
            hoverBorderWidth: 4,
            hoverBorderColor: '#ffffff',
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            animateRotate: true,
            animateScale: true,
            duration: 1000,
            easing: 'easeOutQuart'
          },
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: '#fff',
                font: {
                  family: 'Inter',
                  size: 12
                },
                padding: 15,
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            title: {
              display: true,
              text: labelText,
              color: '#fff',
              font: {
                family: 'Inter',
                size: 18,
                weight: 'bold'
              },
              padding: {
                bottom: 20
              }
            },
            tooltip: {
              backgroundColor: 'rgba(20, 25, 39, 0.9)',
              titleFont: {
                family: 'Inter',
                size: 14,
                weight: 'bold'
              },
              bodyFont: {
                family: 'Inter',
                size: 13
              },
              padding: 12,
              cornerRadius: 8,
              boxPadding: 6,
              displayColors: true,
              usePointStyle: true,
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.formattedValue;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((context.raw / total) * 100);
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }, 500);
  };

  // Generate the charts
  // Severity chart - color by severity
  makeChart('severityChart', severityCounts, 'Events by Severity', 
    severity => severityColors[severity.toUpperCase()] || '#555');

  // Category chart - color by severity of category
  makeChart('categoryChart', categoryCounts, 'Events by Category', 
    category => severityColors[categorySeverity[category]] || '#666');
});
</script>


<body>
  <div class="container">
    <h1><i class="fas fa-shield-alt" style="margin-right: 15px;"></i> {{ org_name }} – Shadowserver Report</h1>
    <div class="info">
      <p><strong><i class="fas fa-hashtag"></i> Reference:</strong> {{ reference_number }}</p>
      <p><strong><i class="fas fa-calendar-alt"></i> Report Date:</strong> {{ generated_on }}</p>
      <p><strong><i class="fas fa-layer-group"></i> TLP:</strong> <span style="color: #ff9900; font-weight: bold;">AMBER</span></p>
    </div>

    <div class="section" style="--delay: 1">
      <h2><i class="fas fa-chart-line" style="margin-right: 10px;"></i> Executive Summary</h2>
      <p>{{ summary_text }}</p>
    </div>

    <div class="section" style="--delay: 2">
      <h2><i class="fas fa-network-wired" style="margin-right: 10px;"></i> IP Event Table</h2>
      <div class="search-container">
        <input class="search-input" type="text" placeholder="Search IPs..." onkeyup="searchTable('ipTable', this.value)">
      </div>
      <div class="table-responsive">
        <table id="ipTable">
          <thead>
            <tr>
              <th><i class="fas fa-laptop" style="margin-right: 8px;"></i> IP</th>
              <th><i class="fas fa-sitemap" style="margin-right: 8px;"></i> Prefix</th>
              <th><i class="fas fa-server" style="margin-right: 8px;"></i> ASN(s)</th>
              <th><i class="fas fa-tags" style="margin-right: 8px;"></i> Categories</th>
              <th><i class="fas fa-project-diagram" style="margin-right: 8px;"></i> ASN→Category Map</th>
            </tr>
          </thead>
          <tbody>
            {% for row in ip_table_rows %}
            <tr>
              <td>{{ row.ip }}</td>
              <td>{{ row.prefix }}</td>
              <td>{{ row.asn }}</td>
              <td>{{ row.categories }}</td>
              <td>{{ row.asn_map }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="section" style="--delay: 3">
      <h2><i class="fas fa-sitemap" style="margin-right: 10px;"></i> Prefix Summary</h2>
      <div class="search-container">
        <input class="search-input" type="text" placeholder="Search Prefixes..." onkeyup="searchTable('prefixTable', this.value)">
      </div>
      <div class="table-responsive">
        <table id="prefixTable">
          <thead>
            <tr>
              <th><i class="fas fa-network-wired" style="margin-right: 8px;"></i> Prefix</th>
              <th><i class="fas fa-hashtag" style="margin-right: 8px;"></i> IP Count</th>
            </tr>
          </thead>
          <tbody>
            {% for prefix, count in prefix_counts %}
            <tr>
              <td>{{ prefix }}</td>
              <td>{{ count }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="section" style="--delay: 4">
      <h2><i class="fas fa-layer-group" style="margin-right: 10px;"></i> Category Metadata</h2>
      <div class="search-container">
        <input class="search-input" type="text" placeholder="Search Categories..." onkeyup="searchTable('categoryTable', this.value)">
      </div>
      <div class="table-responsive">
        <table id="categoryTable">
          <thead>
            <tr>
              <th><i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i> Severity</th>
              <th><i class="fas fa-heading" style="margin-right: 8px;"></i> Title</th>
              <th><i class="fas fa-info-circle" style="margin-right: 8px;"></i> Description</th>
              <th><i class="fas fa-tag" style="margin-right: 8px;"></i> Category</th>
              <th><i class="fas fa-hashtag" style="margin-right: 8px;"></i> IP Count</th>
              <th><i class="fas fa-link" style="margin-right: 8px;"></i> URL</th>
            </tr>
          </thead>
          <tbody>
            {% for row in category_rows %}
            <tr class="severity-{{ row.severity }}">
              <td><span class="badge">{{ row.severity }}</span></td>
              <td>{{ row.title }}</td>
              <td>{{ row.description }}</td>
              <td>{{ row.category }}</td>
              <td>{{ row.count }}</td>
              <td><a href="{{ row.url }}" target="_blank" rel="noopener">{{ row.url }} <i class="fas fa-external-link-alt" style="font-size: 0.8em;"></i></a></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="chart-wrapper">
      <div class="chart-card">
        <canvas id="severityChart"></canvas>
      </div>
      <div class="chart-card">
        <canvas id="categoryChart"></canvas>
      </div>
    </div>

    <div class="tlp-footer">
      TLP:AMBER – This report is confidential between the recipient organization and the reporting CERT.
    </div>
  </div>
</body>
</html>
